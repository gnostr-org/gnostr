#!/usr/bin/env bash

GNOSTR_GIT_REPO="gnostr.git"
GNOSTR_GIT_REMOTE=$(git remote get-url gnostr.git)
#git remote remove $GNOSTR_GIT_REPO >/dev/null || true

remove_remote(){
echo remove_remote
    git remote remove gnostr.git && sleep 1
echo ok
}
add_remote(){
echo add_remote
    git remote add gnostr.git gnostr.git  && sleep 1
echo ok
}
push_to_remote(){
echo push_to_remote
    git push --all gnostr.git || add_remote
echo ok
}
clone_to_gnostr_git(){
echo clone_to_gnostr_Git
    git clone ../ gnostr.git --bare  && sleep 1
    cd gnostr.git && git remote add  local-gnostr.git ../../
echo ok
}

echo GNOSTR_GIT_REPO="$GNOSTR_GIT_REPO";
if [ ! -d "$GNOSTR_GIT_REPO" ]; then
    clone_to_gnostr_git && sleep 10;
    push_to_remote;
fi
GNOSTR_GIT_REMOTE=$(git remote get-url gnostr.git)
export GNOSTR_GIT_REMOTE;
echo GNOSTR_GIT_REMOTE="$GNOSTR_GIT_REMOTE";
if [ -z "$GNOSTR_GIT_REMOTE" ]; then
    add_remote;
    push_to_remote;
fi

LOG_LEVEL=${1:-}
PORT=${2:-3333}
if [ ! $(uname -s) = 'Darwin' ]; then
	if grep -q Microsoft /proc/version; then
		# Ubuntu on Windows using the Linux subsystem
		alias open='explorer.exe';
	else
		alias open='xdg-open';
	fi
fi
cargo install -j8 --path . --root . --force;

echo "Starting gnostr-gnit server..."
cargo run --bin gnostr-gnit -- \
$LOG_LEVEL \
-d .gnostr/web/$(gnostr --weeble)/$(gnostr --blockheight)/$(gnostr --wobble)/$PORT \
-b $PORT \
-s . &
SERVER_PID=$!

# Wait for server to start
echo "Waiting for server to start..."
STATUS=$(curl -s -w "%{http_code}" http://localhost:$PORT/ -o /dev/null)
while [ "$STATUS" -ne 200 ]; do
  sleep 1
  echo $SERVER_PID;
  STATUS=$(curl -s -w "%{http_code}" http://localhost:$PORT/ -o /dev/null)
done
echo "Server started successfully."

echo "Testing server endpoints..."
echo "=========================================="

# Test basic server
echo "1. Testing root endpoint:"
curl -s -w "Status: %{http_code}\n" http://localhost:$PORT/ -o /dev/null

# Test crlf.git repository directly
echo -e "\n2. Testing crlf.git repository:"
curl -s -w "Status: %{http_code}\n" http://localhost:$PORT/crlf.git/tree -o /dev/null
curl -s -w "Status: %{http_code}\n" http://localhost:$PORT/crlf.git/commit -o /dev/null

# Test mount point redirects
echo -e "\n3. Testing mount point redirects:"
echo "3a. /test/tree -> /crlf.git/tree:"
curl -s -I -w "Redirect Status: %{http_code}\n" http://localhost:$PORT/test/tree | grep -E "(HTTP|location)"

echo -e "\n3b. /test/commit -> /crlf.git/commit:"
curl -s -I -w "Redirect Status: %{http_code}\n" http://localhost:$PORT/test/commit | grep -E "(HTTP|location)"

echo -e "\n3c. /test/ -> /crlf.git/tree:"
curl -s -I -w "Redirect Status: %{http_code}\n" http://localhost:$PORT/test/ | grep -E "(HTTP|location)"

# Test follow redirects
echo -e "\n4. Testing following redirects:"
echo "4a. Following /test/tree redirect:"
curl -s -L -w "Final Status: %{http_code}\n" http://localhost:$PORT/test/tree -o /dev/null

echo -e "\n4b. Following /test/commit redirect:"
curl -s -L -w "Final Status: %{http_code}\n" http://localhost:$PORT/test/commit -o /dev/null

# Test patch endpoint
echo -e "\n5. Testing patch endpoint:"
echo "5a. Testing patch with specific commit ID:"
curl -s -w "Status: %{http_code}\n" http://localhost:$PORT/crlf.git/patch?id=00075f5cf3b95f42baba2b355b8a3197f949e297 -o /dev/null

echo "5b. Verifying patch content format:"
curl -s http://localhost:$PORT/crlf.git/patch?id=00075f5cf3b95f42baba2b355b8a3197f949e297 | head -5

echo "5c. Testing patch endpoint error handling:"
curl -s -w "Status: %{http_code}\n" http://localhost:$PORT/crlf.git/patch?id=invalidcommitid -o /dev/null

# Test invalid paths
echo -e "\n6. Testing invalid paths:"
curl -s -w "Status: %{http_code}\n" http://localhost:$PORT/nonexistent -o /dev/null

echo -e "\n=========================================="
echo "Opening browser..."
open http://localhost:$PORT

# Keep server running, or kill if script exits
trap "kill $SERVER_PID 2>/dev/null" EXIT
wait $SERVER_PID
